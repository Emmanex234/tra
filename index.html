<!DOCTYPE html>
<html>
<head>
  <title>Wallet Transfer App</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.7.8/dist/umd/index.min.js"></script>
</head>
<body>
  <h2>Connect Your Wallet</h2>
  <button onclick="connectWallet()">Connect Wallet</button>
  <p id="wallet-address"></p>

  <div id="form" style="display: none;">
    <label>Recipient Address:</label><br>
    <input type="text" id="recipient"><br><br>

    <label>Amount (ETH or BNB):</label><br>
    <input type="number" id="amount"><br><br>

    <label>Network:</label><br>
    <select id="network">
      <option value="eth">Ethereum</option>
      <option value="bsc">Binance Smart Chain</option>
    </select><br><br>

    <button onclick="sendTransaction()">Send</button>
  </div>

  <div id="metamask-redirect" style="display: none;">
    <p>Please open this app in MetaMask mobile browser for full functionality:</p>
    <a href="metamask://dapp/tra-ecru.vercel.app">Open in MetaMask</a>
  </div>

  <script>
    let web3;
    let provider;
    let userAccount;

    function isMetaMaskMobile() {
      return /MetaMask/i.test(navigator.userAgent) && /Android|iPhone/i.test(navigator.userAgent);
    }

    function isMobile() {
      return /Android|iPhone|iPad/i.test(navigator.userAgent);
    }

    async function connectWallet() {
      if (window.ethereum) {
        // MetaMask browser extension or in-app browser
        provider = window.ethereum;
        web3 = new Web3(provider);
        try {
          const accounts = await provider.request({ method: 'eth_requestAccounts' });
          userAccount = accounts[0];
          document.getElementById('wallet-address').innerText = 'Connected: ' + userAccount;
          document.getElementById('form').style.display = 'block';
        } catch (err) {
          alert('User rejected connection');
        }
      } else if (isMobile()) {
        // Mobile external browser
        document.getElementById('metamask-redirect').style.display = 'block';
      } else {
        // Desktop WalletConnect
        provider = new WalletConnectProvider.default({
          rpc: {
            1: "https://mainnet.infura.io/v3/cce34b81ee56450c8e658066a4e8f42e",
            56: "https://bsc-dataseed.binance.org/"
          }
        });

        await provider.enable();
        web3 = new Web3(provider);
        const accounts = await web3.eth.getAccounts();
        userAccount = accounts[0];
        document.getElementById('wallet-address').innerText = 'Connected: ' + userAccount;
        document.getElementById('form').style.display = 'block';
      }
    }

    async function sendTransaction() {
      const recipient = document.getElementById('recipient').value;
      const amount = document.getElementById('amount').value;
      const network = document.getElementById('network').value;

      let chainId;
      if (network === 'eth') chainId = 1;
      if (network === 'bsc') chainId = 56;

      if (provider.request) {
        try {
          await provider.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: '0x' + chainId.toString(16) }]
          });
        } catch (switchError) {
          console.error('Network switch failed', switchError);
        }
      }

      try {
        const tx = await web3.eth.sendTransaction({
          from: userAccount,
          to: recipient,
          value: web3.utils.toWei(amount, 'ether')
        });
        alert('Transaction sent: ' + tx.transactionHash);
      } catch (err) {
        alert('Transaction failed: ' + err.message);
      }
    }
  </script>
</body>
</html>